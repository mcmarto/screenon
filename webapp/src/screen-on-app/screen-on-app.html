<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../data-loader/data-loader.html">
<link rel="import" href="../bar-chart/bar-chart.html">
<link rel="import" href="../cumulated-chart/cumulated-chart.html">
<link rel="import" href="../distribution-chart/distribution-chart.html">
<link rel="import" href="../../bower_components/px-datetime-picker/px-datetime-picker.html">
<link rel="import" href="../../bower_components/px-tabs/px-tabs.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<script src="../../bower_components/chart.js/dist/Chart.bundle.min.js"></script>
<script src="../data_handling.js"></script>

<dom-module id="screen-on-app">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <h2>Hello [[prop1]]!</h2>
    <data-loader on-data-received="fill_table"></data-loader>
  <px-datetime-picker 
    hide-time
    hide-presets
    show-buttons
    block-future-dates
    show-field-titles
    date-format="YYYY/MM/DD"
    min-date="[[min_date]]"
    max-date="[[max_date]]"
    moment-obj-changed="update_selected_day"
  ></px-datetime-picker>
  <px-tabs
    selected="{{selected_chart}}">
    <px-tab id="tab1">Cumulated phone usage</px-tab>
    <px-tab id="tab2">Sleep cycle</px-tab>
    <px-tab id="tab3">Distribution of phone usage</px-tab>
  </px-tabs>
  <iron-pages selected="[[selected_chart]]">
      <div id="tab1-content" style="display: flex; flex-direction: wrap;">
          <bar-chart data="[[grouped_per_day]]" on-day-selected="fill_cumulated"></bar-chart>
          <cumulated-chart data="[[cumulated_per_day]]"></cumulated-chart>
      </div>
      <div id="tab2-content">
          <p>sleep cycle chart coming soon!</p>
      </div>
      <div id="tab3-content">
          <bar-chart data="[[grouped_per_day]]" on-day-selected="fill_distribution"></bar-chart>
          <distribution-chart data="[[distribution_per_day]]"></distribution-chart>
      </div>
  </iron-pages>
  </template>
  <script>
    /**
     * @customElement
     * @polymer
     */
    class ScreenOnApp extends Polymer.Element {
      static get is() { return 'screen-on-app'; }
      static get properties() {
        return {
          prop1: {
            type: String,
            value: 'screen-on-app'
          }
        };
      }

      fill_table(evt) {
        console.log(evt);
        this.formatted_json = evt.detail;
        this.min_date = moment.unix(evt.detail[0].instant);
        this.max_date = moment.unix(evt.detail[evt.detail.length-1].instant);
        this.grouped_per_day = group_by_day(evt.detail);
      }

      fill_cumulated(evt) {
        const index = evt.detail.index;
	const day = this.grouped_per_day[index].interval;
        this.cumulated_per_day = cumulated_time(filter_by_day(this.formatted_json, day));
      }

      fill_distribution(evt) {
        const index = evt.detail.index;
	const day = this.grouped_per_day[index].interval;
        this.distribution_per_day = duration_distribution(filter_by_day(this.formatted_json, day));
      }


      update_selected_day(evt) {
          console.log("update selected day", evt, evt.detail);
      }
    }

    window.customElements.define(ScreenOnApp.is, ScreenOnApp);
  </script>
</dom-module>
